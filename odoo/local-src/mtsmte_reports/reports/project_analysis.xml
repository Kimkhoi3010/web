<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <template id="report_analysis_doc" name="MT analysis report content">
    <t t-call="report.external_layout">
      <t t-set="tasks" t-value="tasks or doc.task_ids"/>
      <div class="page analysis">
        <t t-foreach="tasks" t-as="task">
          <t t-set="product" t-value="task.sale_line_id.product_id" />
          <t t-set="atype" t-value="report.get_analysis_type(product)" />
          <div t-attf-class="task_wrapper type_#{atype}">
            <div class="section task_header">
              <h1 class="heading task_title" t-field="task.name" />
              <div class="content">
                <span t-field="product.description_sale" />
              </div>
            </div>
            <div t-if="task.tested_sample" class="section test_samples">
              <h2 class="heading">Tested samples</h2>
              <div class="content">
                <t t-raw="task.tested_sample" />
              </div>
            </div>
            <div t-if="task._test_parameters_check()" class="section test_params">
              <h2 class="heading">Test / Parameters</h2>
              <div class="content">
                <t t-raw="task.test_parameters" />
              </div>
            </div>
            <t t-if="atype == 'mech_env'">
              <t t-call="mtsmte_reports.mech_env_results" />
            </t>
            <t t-else="">
              <t t-call="mtsmte_reports.chemical_results" />
            </t>
          </div>
        </t>
        <!--Legal reference block-->
        <t t-if="report.display_legal_reference(tasks)">
          <div class="legal_reference">
            <h1>Legal References</h1>
            <t t-set="products" t-value="doc._get_distinct_products()"/>
            <t t-foreach="products" t-as="product">
              <div class="task_wrapper_legal">
                <div class="section task_header">
                  <h2 t-field="product.name"/>
                </div>
                <div class="content">
                  <span t-field="product.legal_reference" />
                </div>
              </div>
            </t>
          </div>
        </t>
      </div>
    </t>
  </template>


  <template id="mech_env_results">
    <t t-set="details" t-value="report.get_mech_env_details(task)" />
    <div class="section mech_env_details" t-if="details">
      <h2 class="heading" t-esc="details['label']"/>
      <div class="content">
        <t t-raw="details['val']" />
      </div>
    </div>
    <div class="section test_results">
      <h2 class="heading">Results &amp;amp; Observations</h2>
      <div class="content">
        <t t-raw="task.results" />
      </div>
    </div>
  </template>


  <template id="chemical_results">
    <div class="section test_results">
      <h2 class="heading">Results &amp;amp; Observations</h2>
      <div class="content">
        <div class="row result-state">
          <div class="col-xs-6">
            <p>
              <strong t-esc="task._get_task_description()"/><br/>
              <em t-if="task.product_method_id">&#91;<span t-field="task.product_method_id"/>&#93; </em>
              <em t-if="task.equipment_id">&#91;<span t-field="task.equipment_id"/>&#93;</em>
            </p>
          </div>
          <div class="col-xs-6">
            <span>Status:
              <t t-if="task.stage_id.final_stage">Definitive</t>
              <t t-else="">Provisory</t>
            </span>
            <br/>
            <span>Analysis date: <span t-field="task.date_deadline"/></span>
          </div>
        </div>
      </div>

      <div class="content">
        <table class="substances">
          <thead>
            <tr>
              <th class="substance">Analyzed substance</th>
              <th class="legal_limit">Legal limit
                <em t-if="task.product_substance_measure_ids">
                    <t t-raw="'['"/><t t-esc="task.product_substance_measure_ids[0].product_uom_id.name"/>&#93;
                </em>
              </th>
              <th class="detect_limit">Detection limit
                <em t-if="task.product_substance_measure_ids">
                    <t t-raw="'['"/><t t-esc="task.product_substance_measure_ids[0].product_uom_id.name"/>&#93;
                </em>
              </th>
              <th class="quantif_limit">Quantification limit
                <em t-if="task.product_substance_measure_ids">
                    <t t-raw="'['"/><t t-esc="task.product_substance_measure_ids[0].product_uom_id.name"/>&#93;
                </em>
              </th>
              <th class="result">Result</th>
              <th class="conformity">Conformity</th>
            </tr>
          </thead>
          <tbody>
            <t t-foreach="task.product_substance_measure_ids" t-as="meas">
              <t t-set="meas" t-value="meas.with_context({'lang': forced_lang or doc.partner_id.lang})"/>
              <tr>
                <td class="substance">
                  <span t-field="meas.product_substance_id" /><br/>
                  <span t-if="meas.product_substance_id.sub_cas_number">&#91;</span>
                  <span t-field="meas.product_substance_id.sub_cas_number"/>
                  <span t-if="meas.product_substance_id.sub_cas_number">&#93;</span>
                </td>
                <td class="legal_limit">
                  <t t-if="meas.legal_limit_min">
                    <span class="limit_min" t-field="meas.legal_limit_min" />
                  </t>
                  <t t-if="meas.legal_limit_max">
                    <span t-if="meas.legal_limit_min" class="limit_max_sep sep">&gt;</span>
                    <span class="limit_max" t-field="meas.legal_limit_max" />
                  </t>
                </td>
                <td class="detect_limit">
                  <span t-field="meas.detection_limit" />
                </td>
                <td class="quantif_limit">
                  <span t-field="meas.quantification_limit" />
                </td>
                <td class="result">
                  <t t-if="meas.bdl">B.D.L</t>
                  <t t-elif="meas.bql">B.Q.L</t>
                  <span t-else="" t-esc="meas.measure or '-'" />
                </td>
                <td class="conformity">
                  <span t-esc="conformity_options[meas.conformity]"/>
                </td>
              </tr>
            </t>
            <tfoot>
              <td colspan="5"/>
              <!-- tasks own conformity is displayed under the last column -->
              <td>
                <strong><span t-esc="conformity_options[doc.conformity]"/></strong>
              </td>
            </tfoot>
          </tbody>
        </table>
        <br/>
      </div>
      <div class="content">
        <t t-raw="task.results" />
      </div>
    </div>
  </template>

  <template id="report_project_analysis">
    <t t-call="report.html_container">
      <t t-set="analysis_report" t-value="1" />
      <t t-foreach="docs" t-as="doc">
        <t t-call="mtsmte_reports.report_analysis_doc" t-lang="forced_lang or doc.partner_id.lang" />
      </t>
    </t>
  </template>

</odoo>
