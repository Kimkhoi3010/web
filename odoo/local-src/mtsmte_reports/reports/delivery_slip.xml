<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- adding top margin to create some space before address -->
  <!-- also add name to ease further overriding -->
  <template id="report_delivery_document_inherit_mtsmte" inherit_id="sale_stock.report_delivery_document_inherit_sale_stock">
    <!-- initialize helper object asap -->
    <xpath expr="//div[hasclass('page')]" position="before">
      <t t-set="helper" t-value="request.env['stock.picking.report_deliveryslip_helper']"/>
    </xpath>

    <xpath expr="//div[@t-if='o.sale_id.client_order_ref']" position="attributes">
      <attribute name="name">customer_reference</attribute>
      <attribute name="class" add="mt32" separator=" "/>
    </xpath>

    <xpath expr="//div[@t-if='o.sale_id.client_order_ref']/div" position="attributes">
        <attribute name="class">col-xs-12 pull-left</attribute>
    </xpath>

    <xpath expr="//table[@t-if='o.pack_operation_ids']/thead//th/*[text()='Quantity']" position="replace">
      <strong>Ordered Quantity</strong>
    </xpath>
    <xpath expr="//span[@t-field='pack_operation.qty_done_uom_ordered']" position="replace">
      <span>
        <t t-esc="helper._get_ordered_qty(pack_operation)"/>
      </span>
    </xpath>

    <xpath expr="//table[@t-if='o.pack_operation_ids']/thead//th[last()]"
           position="after">
      <th t-if="any([pack_operation.state == 'done' for pack_operation in o.pack_operation_ids])"
          class="text-right"><strong>Delivered Quantity</strong></th>
      <th class="text-right">Balance to deliver</th>
    </xpath>

    <xpath expr="//table[@t-if='o.pack_operation_ids']/tbody/tr/td[last()]" position="after">
      <td class="text-right" t-if="pack_operation.state == 'done'">
        <span><t t-esc="helper._prettify_value(pack_operation.qty_done)" /></span>
        <span t-field="pack_operation.product_uom_id"/>
      </td>
      <td class="text-right">
        <span>
          <t t-esc="helper._get_balance_to_deliver(pack_operation)"/>
        </span>
        <t t-if="pack_operation.linked_move_operation_ids">
          <span t-field="pack_operation.linked_move_operation_ids[0].move_id.product_uom"/>
        </t>
        <t t-else="">
          <span t-field="pack_operation.product_uom_id"/>
        </t>
      </td>
    </xpath>

    <xpath expr="//p[@t-if='o.backorder_id']" position="before">
      <t t-if="o.note">
        <t t-esc="o.note"/>
      </t>
    </xpath>

    <xpath expr="//div[@class='col-xs-4 pull-right']" position="replace">
      <div class="col-xs-4 pull-right">
        <div t-if="o.move_lines and o.move_lines[0].partner_id"
             name="partner_header">
          <div t-field="o.move_lines[0].partner_id"
               t-options="{'widget': 'contact', 'fields': ['address', 'name'], 'no_marker': True}"/>
        </div>
        <div t-if="not (o.move_lines and o.move_lines[0].partner_id) and o.partner_id"
             name="partner_header">
          <div t-field="o.partner_id"
               t-options="{'widget': 'contact', 'fields': ['address', 'name'], 'no_marker': True}"/>
        </div>
      </div>
    </xpath>

    <xpath expr="//span[@t-if='pack_operation.package_id']" position="replace"/>
    <xpath expr="//p[@t-if='o.backorder_id']" position="replace"/>

    <xpath expr="//span[@t-field='pack_operation.product_id']" position="after">
      <span t-field="pack_operation.product_id.description_sale"/>
    </xpath>

    <xpath expr="//div[@t-if='o.sale_id.client_order_ref']" position="before">
      <h2>
        <span>Delivery Slip</span>
      </h2>
    </xpath>
  </template>

</odoo>
