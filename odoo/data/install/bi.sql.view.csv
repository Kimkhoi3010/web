id,name,technical_name,view_order,is_materialized,query
__setup__.bi_sql_view_engagements,Engagements,engagements,"pivot,graph,tree",False,"SELECT
eng.doc_number x_doc_number,
eng.invoice_status x_invoice_status,
eng.partner x_partner,
eng.ref_date x_ref_date,
eng.currency x_currency,
eng.doc_total x_doc_total,
eng.total_already_invoiced x_already_invoiced,
eng.engagements x_engagements
FROM   (SELECT so_line.doc_number,
               so_line.invoice_status,
               so_line.partner,
               so_line.confirmation_date
                       ref_date,
               so_line.currency,
               Sum(so_line.line_total)
                       doc_total,
               Sum(so_line.total_already_invoiced)
                       total_already_invoiced,
               ( Sum(so_line.line_total) - Sum(so_line.total_already_invoiced)
                )
                       engagements
        FROM   (SELECT so.NAME         doc_number,
                       so.invoice_status,
                       part.NAME       partner,
                       so.confirmation_date,
                       cur.NAME        currency,
                       sol.price_total line_total,
                       COALESCE((SELECT Sum(COALESCE(il.price_unit, 0) *
                                            COALESCE(il.quantity, 0))
                                 FROM   sale_order_line_invoice_rel lnk,
                                        account_invoice_line il
                                 WHERE  sol.id = lnk.order_line_id
                                    AND lnk.invoice_line_id = il.id
                                    AND EXISTS (SELECT 1
                                                FROM   account_invoice ai
                                                WHERE  ai.id = il.invoice_id
                                                   AND ai.state NOT IN (
                                                       'cancel' ))),
                       0
                       )
                                       total_already_invoiced
                FROM   sale_order so,
                       sale_order_line sol,
                       res_partner part,
                       res_currency cur
                WHERE  so.id = sol.order_id
                   AND so.partner_id = part.id
                   AND sol.currency_id = cur.id
                   AND so.invoice_status NOT IN ( 'no' ))so_line
        GROUP  BY so_line.doc_number,
                  so_line.invoice_status,
                  so_line.partner,
                  so_line.confirmation_date,
                  so_line.currency
        UNION ALL
        SELECT po_line.doc_number,
               po_line.invoice_status,
               po_line.partner,
               po_line.date_planned
               ref_date,
               po_line.currency,
               -Sum(po_line.line_total)
               doc_total,
               Sum(po_line.total_already_invoiced)
               total_already_invoiced,
               -( Sum(po_line.line_total) - Sum(po_line.total_already_invoiced)
                )
               engagements
        FROM   (SELECT po.NAME         doc_number,
                       part.NAME       partner,
                       po.date_planned,
                       cur.NAME        currency,
                       pol.price_total line_total,
                       po.invoice_status,
                       COALESCE((SELECT Sum(COALESCE(il.price_unit, 0) *
                                            COALESCE(il.quantity, 0))
                                 FROM   account_invoice_line il,
                                        account_invoice_line_tax tax
                                 WHERE  pol.id = il.purchase_line_id
                                    AND il.id = tax.invoice_line_id
                                    AND EXISTS (SELECT 1
                                                FROM   account_invoice ai
                                                WHERE  ai.id = il.invoice_id
                                                   AND ai.state NOT IN (
                                                       'cancel' ))),
                       0
                       )
                                       total_already_invoiced
                FROM   purchase_order po,
                       purchase_order_line pol,
                       res_partner part,
                       res_currency cur
                WHERE  po.id = pol.order_id
                   AND po.partner_id = part.id
                   AND pol.currency_id = cur.id
                   AND po.invoice_status NOT IN ( 'no' )) po_line
        GROUP  BY po_line.doc_number,
                  po_line.partner,
                  po_line.invoice_status,
                  po_line.date_planned,
                  po_line.currency) eng
WHERE  eng.engagements <> 0"
